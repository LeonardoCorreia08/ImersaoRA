<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- 
        viewport-fit=cover: Faz a p√°gina ocupar toda a tela em dispositivos com notch (iPhone X+)
        user-scalable=no: Desabilita o zoom manual (importante para AR)
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Projeto WebAR - Leon Kennedy</title>
    
    <!-- 
        ============================================
        BIBLIOTECAS NECESS√ÅRIAS PARA WEBAR
        ============================================
        A-Frame: Framework para criar experi√™ncias 3D/VR na web
        AR.js: Biblioteca que adiciona capacidades de AR ao A-Frame
        A-Frame Extras: Componentes adicionais (como animation-mixer para anima√ß√µes GLTF)
    -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        /* ============================================
           ESTILOS GERAIS DA P√ÅGINA
           ============================================ */
        
        body {
            margin: 0;           /* Remove margens padr√£o do navegador */
            overflow: hidden;    /* Esconde scrollbars (importante para fullscreen AR) */
        }
        
        /* ============================================
           BOT√ÉO DE FECHAR (Canto Superior Direito)
           ============================================ */
        #closeButton {
            position: absolute;              /* Posicionamento absoluto na tela */
            top: 20px;                       /* 20px do topo */
            right: 20px;                     /* 20px da direita */
            width: 50px;                     /* Largura do bot√£o */
            height: 50px;                    /* Altura do bot√£o (quadrado) */
            background: rgba(255, 0, 0, 0.85); /* Vermelho semi-transparente */
            border: 2px solid white;         /* Borda branca de 2px */
            border-radius: 50%;              /* Torna o bot√£o circular */
            cursor: pointer;                 /* Muda cursor para pointer ao passar sobre */
            z-index: 1001;                   /* Fica acima de tudo (maior que instructions) */
            display: flex;                   /* Flexbox para centralizar conte√∫do */
            align-items: center;             /* Centraliza verticalmente */
            justify-content: center;         /* Centraliza horizontalmente */
            font-size: 28px;                 /* Tamanho do "√ó" */
            color: white;                    /* Cor do texto */
            font-weight: bold;               /* Texto em negrito */
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Sombra para destacar */
            transition: all 0.3s ease;       /* Anima√ß√£o suave de 0.3 segundos */
            font-family: Arial, sans-serif;  /* Fonte padr√£o */
            user-select: none;               /* Impede sele√ß√£o do texto */
        }
        
        /* Efeito ao passar o mouse sobre o bot√£o (apenas desktop) */
        #closeButton:hover {
            background: rgba(255, 50, 50, 1);    /* Vermelho mais forte */
            transform: scale(1.1) rotate(90deg); /* Aumenta 10% e rotaciona 90¬∞ */
            box-shadow: 0 6px 20px rgba(255,0,0,0.5); /* Sombra vermelha */
        }
        
        /* Efeito ao clicar no bot√£o */
        #closeButton:active {
            transform: scale(0.95) rotate(90deg); /* Diminui um pouco (feedback t√°til) */
        }
        
        /* ============================================
           PAINEL DE INSTRU√á√ïES (Parte Inferior)
           ============================================ */
        #instructions {
            position: absolute;              /* Posicionamento absoluto */
            bottom: 20px;                    /* 20px do fundo */
            left: 50%;                       /* Come√ßa no meio horizontal */
            transform: translateX(-50%);     /* Move 50% do pr√≥prio tamanho para esquerda (centraliza) */
            background: rgba(0, 0, 0, 0.85); /* Fundo preto semi-transparente */
            color: white;                    /* Texto branco */
            padding: 15px 30px;              /* Espa√ßamento interno */
            border-radius: 12px;             /* Bordas arredondadas */
            font-family: 'Segoe UI', Arial, sans-serif; /* Fontes modernas */
            text-align: center;              /* Texto centralizado */
            z-index: 1000;                   /* Fica acima da cena AR */
            max-width: 85%;                  /* M√°ximo 85% da largura da tela */
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Sombra suave */
        }
        
        /* T√≠tulo das instru√ß√µes */
        #instructions h3 {
            margin: 0 0 12px 0;  /* Remove margem superior, adiciona inferior */
            font-size: 18px;     /* Tamanho da fonte */
            font-weight: bold;   /* Negrito */
        }
        
        /* Par√°grafos de instru√ß√£o */
        #instructions p {
            margin: 8px 0;       /* Espa√ßamento entre par√°grafos */
            font-size: 15px;     /* Tamanho da fonte */
            line-height: 1.4;    /* Altura da linha (espa√ßamento vertical) */
        }
        
        /* √çcones dentro das instru√ß√µes */
        .icon {
            display: inline-block;  /* Permite margem */
            margin-right: 8px;      /* Espa√ßo entre √≠cone e texto */
        }
    </style>
</head>
<body>
    <!-- ============================================
         INTERFACE DO USU√ÅRIO (UI)
         ============================================ -->
    
    <!-- Bot√£o para fechar/sair do WebAR -->
    <div id="closeButton" title="Fechar WebAR">√ó</div>
    
    <!-- Painel de instru√ß√µes (desaparece ap√≥s 7 segundos) -->
    <div id="instructions">
        <h3>üéÆ Intera√ß√µes Dispon√≠veis</h3>
        <p><span class="icon">üëÜ</span><strong>Toque r√°pido:</strong> Animar e girar 360¬∞</p>
        <p><span class="icon">‚úã</span><strong>Pressionar e segurar:</strong> Aumentar tamanho</p>
        <p><span class="icon">‚ÜîÔ∏è</span><strong>Arrastar horizontalmente:</strong> Girar manualmente</p>
    </div>

    <!-- ============================================
         CENA A-FRAME (Realidade Aumentada)
         ============================================ -->
    <a-scene
        embedded
        arjs="
            sourceType: webcam;              
            debugUIEnabled: false;           
            detectionMode: mono_and_matrix;  
            matrixCodeType: 3x3;             
            trackingMethod: best;            
            maxDetectionRate: 60;            
        "
        vr-mode-ui="enabled: false"
        renderer="
            logarithmicDepthBuffer: true;    
            precision: medium;               
            antialias: true;                 
            colorManagement: true;           
        "
        gesture-detector>
        
        <!-- ============================================
             ASSETS (Recursos da Cena)
             ============================================
             Pr√©-carrega os modelos 3D antes de usar
        -->
        <a-assets>
            <!-- 
                Modelo GLTF do Leon Kennedy
                O arquivo leon.glb deve estar na mesma pasta 
            -->
            <a-asset-item id="leonModel" src="leon.glb"></a-asset-item>
        </a-assets>
        
        <!-- C√¢mera virtual (ponto de vista do usu√°rio) -->
        <a-entity camera></a-entity>

        <!-- ============================================
             MARCADOR AR (Padr√£o Hiro)
             ============================================
             O marcador Hiro √© um quadrado preto com borda preta
             Imprima de: https://github.com/LeonardoCorreia08/ImersaoRA/blob/main/assets/hiro.png
        -->
        <a-marker 
            preset="hiro"                    
            id="marker"                      
            raycaster="objects: .clickable"  
            emitevents="true"                
            cursor="fuse: false; rayOrigin: mouse;">
            
            <!-- Container que agrupa modelo e luzes -->
            <a-entity id="model-container" position="0 0 0">
                
                <!-- ============================================
                     SISTEMA DE ILUMINA√á√ÉO
                     ============================================
                     M√∫ltiplas luzes 
                -->
                
                <!-- Luz Ambiente: Ilumina√ß√£o geral uniforme (sem dire√ß√£o) -->
                <a-light 
                    type="ambient"           
                    color="#ffffff"          
                    intensity="1.2">         
                </a-light>
                
                <!-- Luz Direcional: Simula luz do sol (vem de uma dire√ß√£o espec√≠fica) -->
                <a-light 
                    type="directional"       
                    color="#ffffff"          
                    intensity="1.5"          
                    position="2 4 2">        
                </a-light>
                
                <!-- Luz Pontual 1: Luz de preenchimento (reduz sombras escuras) -->
                <a-light 
                    type="point"             
                    color="#b3d9ff"          
                    intensity="0.8"          
                    position="-2 2 2"        
                    distance="5">            
                </a-light>
                
                <!-- Luz Pontual 2: Luz de destaque (adiciona brilho) -->
                <a-light 
                    type="point"             
                    color="#ffffff"          
                    intensity="0.6"          
                    position="0 3 -2"        
                    distance="4">            
                </a-light>
                
                <!-- ============================================
                     MODELO 3D - LEON KENNEDY
                     ============================================ -->
                <a-entity
                    id="model"                    
                    class="clickable"             
                    gltf-model="#leonModel"       
                    scale="1.2 1.2 1.2"           
                    position="0 0 0"              
                    rotation="0 180 0"            
                    animation-mixer               
                    gesture-handler>              
                </a-entity>
            </a-entity>
            
        </a-marker>
    </a-scene>

    <script>
        /* ============================================
           JAVASCRIPT - L√ìGICA DE INTERA√á√ïES
           ============================================ */
        
        // ========================================
        // COMPONENTE 1: DETECTOR DE GESTOS
        // ========================================
        /*
            Este componente detecta 3 tipos de gestos:
            1. Tap (toque r√°pido)
            2. Press (pressionar e segurar)
            3. Drag (arrastar)
        */
        AFRAME.registerComponent('gesture-detector', {
            // Schema define propriedades configur√°veis do componente
            schema: {
                enabled: { default: true }  // Pode ligar/desligar o detector
            },
            
            // init(): Executado uma vez quando o componente √© inicializado
            init: function() {
                // Bind garante que "this" sempre se refere ao componente
                this.handleTap = this.handleTap.bind(this);
                this.handleTouchStart = this.handleTouchStart.bind(this);
                this.handleTouchEnd = this.handleTouchEnd.bind(this);
                this.handleTouchMove = this.handleTouchMove.bind(this);
                
                // Vari√°veis para rastrear o estado do toque
                this.startX = 0;        // Posi√ß√£o X inicial do toque
                this.startY = 0;        // Posi√ß√£o Y inicial do toque
                this.isDragging = false; // Se est√° arrastando
                this.moved = false;      // Se o dedo se moveu
            },
            
            // play(): Executado quando o componente √© ativado
            play: function() {
                const canvas = this.el.sceneEl.canvas;  // Pega o canvas da cena
                
                // Adiciona event listeners (escutadores de eventos)
                canvas.addEventListener('click', this.handleTap);
                canvas.addEventListener('touchstart', this.handleTouchStart);
                canvas.addEventListener('touchend', this.handleTouchEnd);
                canvas.addEventListener('touchmove', this.handleTouchMove);
            },
            
            // pause(): Executado quando o componente √© desativado
            pause: function() {
                const canvas = this.el.sceneEl.canvas;
                
                // Remove event listeners (boa pr√°tica para economizar mem√≥ria)
                canvas.removeEventListener('click', this.handleTap);
                canvas.removeEventListener('touchstart', this.handleTouchStart);
                canvas.removeEventListener('touchend', this.handleTouchEnd);
                canvas.removeEventListener('touchmove', this.handleTouchMove);
            },
            
            // Trata clicks do mouse (Desktop)
            handleTap: function(evt) {
                console.log('üñ±Ô∏è Click detectado (Desktop)');
                // Emite evento customizado que ser√° capturado pelo gesture-handler
                this.el.emit('gesture-tap', evt);
            },
            
            // Quando o usu√°rio toca na tela
            handleTouchStart: function(evt) {
                // Verifica se h√° exatamente 1 dedo na tela
                if (evt.touches && evt.touches.length === 1) {
                    // Guarda a posi√ß√£o inicial do toque
                    this.startX = evt.touches[0].clientX;
                    this.startY = evt.touches[0].clientY;
                    this.startTime = Date.now();  // Guarda o tempo (para detectar tap r√°pido)
                    this.isDragging = false;
                    this.moved = false;
                }
                
                // Emite evento de in√≠cio de press√£o
                this.el.emit('gesture-pressstart', evt);
            },
            
            // Quando o usu√°rio move o dedo na tela
            handleTouchMove: function(evt) {
                if (evt.touches && evt.touches.length === 1) {
                    // Calcula quanto o dedo se moveu
                    const deltaX = evt.touches[0].clientX - this.startX;
                    const deltaY = evt.touches[0].clientY - this.startY;
                    
                    // Teorema de Pit√°goras: dist√¢ncia = ‚àö(x¬≤ + y¬≤)
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    
                    // Se moveu mais de 15 pixels, considera como arrasto
                    if (distance > 15) {
                        this.moved = true;
                        this.isDragging = true;
                        // Emite evento de arrasto com a varia√ß√£o em X
                        this.el.emit('gesture-drag', { deltaX: deltaX });
                    }
                }
            },
            
            // Quando o usu√°rio tira o dedo da tela
            handleTouchEnd: function(evt) {
                // Calcula h√° quanto tempo o dedo est√° pressionado
                const touchDuration = Date.now() - this.startTime;
                
                // Detecta TAP: n√£o moveu E foi r√°pido (menos de 300ms)
                if (!this.moved && touchDuration < 300) {
                    console.log('üëÜ Tap detectado (Mobile)!');
                    this.el.emit('gesture-tap', evt);
                }
                
                // Emite evento de fim de press√£o
                this.el.emit('gesture-pressend', evt);
                
                // Reseta as flags
                this.isDragging = false;
                this.moved = false;
            }
        });
        
        // ========================================
        // COMPONENTE 2: GERENCIADOR DE INTERA√á√ïES
        // ========================================
        /*
            Este componente responde aos gestos detectados acima
            e executa as a√ß√µes no modelo 3D:
            - Tap: Anima e gira 360¬∞
            - Press: Aumenta tamanho
            - Drag: Rotaciona manualmente
        */
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                scaleMin: { default: 1.2 },  // Escala m√≠nima
                scaleMax: { default: 5 }      // Escala m√°xima
            },
            
            init: function() {
                // Guarda a escala inicial do modelo
                this.initialScale = this.el.object3D.scale.clone();
                this.currentScale = 1;        // Escala atual (multiplicador)
                this.isPressed = false;       // Se est√° sendo pressionado
                this.scaleInterval = null;    // Intervalo para aumentar escala
                this.lastDragX = 0;           // √öltima posi√ß√£o do arrasto
                
                // Faz bind de todas as fun√ß√µes
                this.onTap = this.onTap.bind(this);
                this.onPressStart = this.onPressStart.bind(this);
                this.onPressEnd = this.onPressEnd.bind(this);
                this.onDrag = this.onDrag.bind(this);
                
                // Registra listeners para os eventos emitidos pelo gesture-detector
                const sceneEl = this.el.sceneEl;
                sceneEl.addEventListener('gesture-tap', this.onTap);
                sceneEl.addEventListener('gesture-pressstart', this.onPressStart);
                sceneEl.addEventListener('gesture-pressend', this.onPressEnd);
                sceneEl.addEventListener('gesture-drag', this.onDrag);
                
                console.log('‚úì Sistema de intera√ß√µes carregado');
            },
            
            // ========================================
            // INTERA√á√ÉO 1: TOQUE R√ÅPIDO (TAP)
            // Anima com pulso e rotaciona 360¬∞
            // ========================================
            onTap: function(evt) {
                console.log('üëÜ Executando anima√ß√£o de tap (360¬∞ + pulso)');
                
                // Remove anima√ß√µes anteriores (evita conflitos)
                this.el.removeAttribute('animation');
                this.el.removeAttribute('animation__rotation');
                
                // ANIMA√á√ÉO 1: Pulso (aumenta e diminui rapidamente)
                this.el.setAttribute('animation', {
                    property: 'scale',  // Propriedade a animar
                    from: {             // Valor inicial
                        x: this.initialScale.x * this.currentScale,
                        y: this.initialScale.y * this.currentScale,
                        z: this.initialScale.z * this.currentScale
                    },
                    to: {               // Valor final (30% maior)
                        x: this.initialScale.x * this.currentScale * 1.3,
                        y: this.initialScale.y * this.currentScale * 1.3,
                        z: this.initialScale.z * this.currentScale * 1.3
                    },
                    dur: 200,           // Dura√ß√£o: 200ms
                    easing: 'easeOutQuad', // Curva de anima√ß√£o (r√°pido no in√≠cio, devagar no fim)
                    loop: 1,            // Repete 1 vez
                    dir: 'alternate'    // Vai e volta (aumenta e diminui)
                });
                
                // ANIMA√á√ÉO 2: Rota√ß√£o 360¬∞
                const currentRotation = this.el.getAttribute('rotation');
                this.el.setAttribute('animation__rotation', {
                    property: 'rotation',
                    from: {
                        x: currentRotation.x,
                        y: currentRotation.y,
                        z: currentRotation.z
                    },
                    to: {
                        x: currentRotation.x,
                        y: currentRotation.y + 360,  // Adiciona 360¬∞ no eixo Y
                        z: currentRotation.z
                    },
                    dur: 1500,          // Dura√ß√£o: 1.5 segundos
                    easing: 'easeInOutCubic', // Anima√ß√£o suave
                    loop: false         // N√£o repete
                });
            },
            
            // ========================================
            // INTERA√á√ÉO 2: ARRASTAR (DRAG)
            // Rotaciona o modelo manualmente
            // ========================================
            onDrag: function(evt) {
                const deltaX = evt.detail.deltaX;  // Quanto arrastou em X
                
                // Calcula a diferen√ßa desde o √∫ltimo frame
                const dragDelta = deltaX - this.lastDragX;
                this.lastDragX = deltaX;
                
                // Rotaciona baseado no arrasto
                const currentRotation = this.el.getAttribute('rotation');
                const rotationSpeed = 0.5;  // Sensibilidade (quanto maior, mais sens√≠vel)
                
                // Aplica a rota√ß√£o no eixo Y
                this.el.setAttribute('rotation', {
                    x: currentRotation.x,
                    y: currentRotation.y + (dragDelta * rotationSpeed),
                    z: currentRotation.z
                });
                
                // Cancela o aumento de escala durante o arrasto
                this.isPressed = false;
                if (this.scaleInterval) {
                    clearInterval(this.scaleInterval);
                    this.scaleInterval = null;
                }
            },
            
            // ========================================
            // INTERA√á√ÉO 3: PRESSIONAR E SEGURAR (PRESS)
            // Aumenta gradualmente o tamanho
            // ========================================
            onPressStart: function(evt) {
                console.log('‚úã Pressionar iniciado - Aumentando tamanho');
                this.isPressed = true;
                
                // Cria um intervalo que executa a cada 50ms
                this.scaleInterval = setInterval(() => {
                    // S√≥ aumenta se ainda estiver pressionado e n√£o atingiu o m√°ximo
                    if (this.isPressed && this.currentScale < this.data.scaleMax) {
                        this.currentScale += 0.06;  // Aumenta 6% a cada 50ms
                        
                        // Limita ao m√°ximo configurado
                        if (this.currentScale > this.data.scaleMax) {
                            this.currentScale = this.data.scaleMax;
                        }
                        
                        // Aplica a nova escala
                        this.el.object3D.scale.set(
                            this.initialScale.x * this.currentScale,
                            this.initialScale.y * this.currentScale,
                            this.initialScale.z * this.currentScale
                        );
                    }
                }, 50);  // Executa a cada 50 milissegundos
            },
            
            // Quando o usu√°rio para de pressionar
            onPressEnd: function(evt) {
                console.log('‚Ü©Ô∏è Pressionar finalizado - Voltando ao normal');
                this.isPressed = false;
                this.lastDragX = 0;  // Reseta o drag
                
                // Para o intervalo de aumento
                if (this.scaleInterval) {
                    clearInterval(this.scaleInterval);
                    this.scaleInterval = null;
                }
                
                // Retorna ao tamanho original com anima√ß√£o suave
                this.el.setAttribute('animation__scaledown', {
                    property: 'scale',
                    to: {
                        x: this.initialScale.x,
                        y: this.initialScale.y,
                        z: this.initialScale.z
                    },
                    dur: 500,           // Dura√ß√£o: 500ms
                    easing: 'easeOutQuad',
                    loop: false
                });
                
                // Reseta o multiplicador de escala
                this.currentScale = 1;
            },
            
            // Limpeza quando o componente √© removido
            remove: function() {
                const sceneEl = this.el.sceneEl;
                sceneEl.removeEventListener('gesture-tap', this.onTap);
                sceneEl.removeEventListener('gesture-pressstart', this.onPressStart);
                sceneEl.removeEventListener('gesture-pressend', this.onPressEnd);
                sceneEl.removeEventListener('gesture-drag', this.onDrag);
                
                if (this.scaleInterval) {
                    clearInterval(this.scaleInterval);
                }
            }
        });
        
        // ========================================
        // MONITORAMENTO E BOT√ÉO DE FECHAR
        // ========================================
        
        // Seleciona elementos da p√°gina
        const scene = document.querySelector('a-scene');
        const marker = document.getElementById('marker');
        const model = document.getElementById('model');
        const closeButton = document.getElementById('closeButton');
        
        // ========================================
        // BOT√ÉO DE FECHAR
        // ========================================
        closeButton.addEventListener('click', function() {
            // Pede confirma√ß√£o antes de fechar
            if (confirm('Deseja realmente sair do WebAR?')) {
                // Para a c√¢mera (libera recurso do sistema)
                const video = document.querySelector('video');
                if (video && video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                
                // Tenta voltar para a p√°gina anterior
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Se n√£o conseguir voltar, tenta fechar a aba
                    window.close();
                    
                    // Se n√£o conseguir fechar, mostra mensagem
                    setTimeout(() => {
                        document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial; flex-direction: column;"><h1>‚úì WebAR Encerrado</h1><p>Voc√™ pode fechar esta aba agora.</p></div>';
                    }, 100);
                }
            }
        });
        
        // ========================================
        // EVENTOS DE MONITORAMENTO
        // ========================================
        
        // Quando a cena A-Frame termina de carregar
        scene.addEventListener('loaded', function() {
            console.log('‚úì A-Frame carregado com sucesso');
        });
        
        // Quando o marcador Hiro √© detectado pela c√¢mera
        marker.addEventListener('markerFound', function() {
            console.log('‚úì Marcador Hiro detectado! Modelo vis√≠vel');
        });
        
        // Quando o marcador Hiro sai do campo de vis√£o
        marker.addEventListener('markerLost', function() {
            console.log('‚ö† Marcador perdido - aponte a c√¢mera novamente');
        });
        
        // Quando o modelo 3D termina de carregar
        model.addEventListener('model-loaded', function() {
            console.log('‚úì Modelo Leon Kennedy carregado com sucesso!');
        });
        
        // Se houver erro ao carregar o modelo
        model.addEventListener('model-error', function(evt) {
            console.error('‚úó Erro ao carregar modelo:', evt);
            alert('Erro: Verifique se o arquivo leon.glb est√° na mesma pasta do HTML');
        });
        
        // ========================================
        // OCULTAR INSTRU√á√ïES AUTOMATICAMENTE
        // ========================================
        // Ap√≥s 7 segundos, esconde as instru√ß√µes gradualmente
        setTimeout(() => {
            const instructions = document.getElementById('instructions');
            if (instructions) {
                // Adiciona transi√ß√£o de opacidade
                instructions.style.transition = 'opacity 1s';
                instructions.style.opacity = '0';  // Fica invis√≠vel
                
                // Remove do DOM ap√≥s a anima√ß√£o (1 segundo depois)
                setTimeout(() => instructions.remove(), 1000);
            }
        }, 7000);  // 7000 milissegundos = 7 segundos
        
        console.log('‚úì Sistema WebAR iniciado e pronto para uso!');
    </script>
</body>
</html>